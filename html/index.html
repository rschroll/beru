<!DOCTYPE html>
<html lang="en">
<!--
Copyright 2013 Robert Schroll

This file is part of Beru and is distributed under the terms of
the GPL. See the file COPYING for full details.
-->
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, user-scalable=no">

<script src=".monocle/scripts/monocore.js"></script>
<script src=".monocle/scripts/monoctrl.js"></script>
<script src=".bookdata.js"></script>
<script src=".messaging.js"></script>
<script src=".defaults.js"></script>
<script src=".styling.js"></script>
<script>
function createReader(bookData) {
    var styleInfo = styleManager.init(bookData.getMetaData("title"));
    var reader = Monocle.Reader("reader", bookData,
        { panels: Monocle.Panels.TwoPane, place: SAVED_PLACE,
          stylesheet: styleInfo.stylesheet, fontScale: styleInfo.fontScale},
        function (reader) {
            var stencil = new Monocle.Controls.Stencil(reader);
            reader.addControl(stencil);
            styleManager.reader = reader;
            Monocle.Browser.env.supportsTransform3d = false;  // Fix for paging backwards
            Messaging.sendMessage("Ready");
        }
    );
    Messaging.registerHandler("NavigateChapter", function (src) {
        reader.skipToChapter(src);
    });
    Messaging.registerHandler("GotoLocus", function(locus) {
        reader.moveTo(locus);
    });
    Messaging.registerHandler("Styles", styleManager.updateStyles);
    Messaging.registerHandler("ResetStylesToDefault", styleManager.resetToDefault);
    Messaging.registerHandler("SetDefaultStyles", styleManager.setDefault);
    Messaging.registerHandler("WindowSizeChanged", function () {
        reader.resized();
    });
    Messaging.registerHandler("ChangePage", function(dir) {
        reader.moveTo({direction: dir});
    });

    reader.listen("monocle:link:external", function(event) {
        Messaging.sendMessage("ExternalLink", event.m.href.external);
    });
    reader.listen("monocle:jumping", function(event) {
        Messaging.sendMessage("Jumping", [reader.getPlace().getLocus(), event.m.locus]);
    });
    reader.listen("monocle:pagechange", function(event) {
        var place = reader.getPlace();

        // Following code taken from Monacle to estimate overall pages

        var book = place.properties.component.properties.book;
        var componentIds = book.properties.componentIds;
        var weights = book.componentWeights();
        var cmptIndex = place.properties.component.properties.index;
        var pc = weights[cmptIndex] * place.properties.percent;
        for (var i = 0, ii = cmptIndex; i < ii; ++i) { pc += weights[i]; }

        // Note: This is a decent estimation of current page number and total
        // number of pages, but it's very approximate. Could be improved by storing
        // the page counts of all components accessed (since the dimensions of the
        // reader last changed), and averaging the result across them. (You
        // probably want to ignore calcs for components < 2 or 3 pages long, too.
        // The bigger the component, the more accurate the calculation.)
        //
        var bkPages = place.properties.component.lastPageNumber() / weights[cmptIndex];

        Messaging.sendMessage("PageChange", { chapterSrc: place.chapterSrc(),
                                              componentId: place.componentId(),
                                              percent: place.percentageThrough(),
                                              title: place.chapterTitle(),
                                              page: Math.floor(pc * bkPages),
                                              pages: Math.floor(bkPages),
                                              totalPercentage: pc
                                            });
    });
}

window.onload = function () {
    createReader(bookData);
}
</script>

<link rel="stylesheet" type="text/css" href=".monocle/styles/monocore.css" />
<link rel="stylesheet" type="text/css" href=".monocle/styles/monoctrl.css" />
<style type="text/css">
div#reader {
    position: absolute;
    left: 0;
    right: 0;
    top: 0;
    bottom: 0;
}
div.monelem_page {
    bottom: 0;
    right: 0;
}
div.monelem_flippers_slider_wait {
    background: none;
}
</style>
<style type="text/css" id="appliedStyles"> </style>
</head>

<body>
<div id="reader"></div>
</body>
</html>
